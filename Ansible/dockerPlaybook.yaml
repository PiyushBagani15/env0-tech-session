---
- name: Setup HTTPD server in Docker container on EC2 instance
  hosts: all
  become_user: root
  become: yes
  tasks:

    - name: Update apt-get package lists (Ubuntu)
      apt:
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Install required packages (RedHat/CentOS)
      yum:
        name:
          - yum-utils
          - device-mapper-persistent-data
          - lvm2
        state: present
      when: ansible_os_family == "RedHat"

    - name: Add Docker repository (RedHat/CentOS)
      yum_repository:
        name: docker
        description: Docker Repository
        baseurl: https://download.docker.com/linux/centos/docker-ce.repo
        gpgcheck: yes
        gpgkey: https://download.docker.com/linux/centos/gpg
        state: present
      when: ansible_os_family == "RedHat"

    - name: Install Docker
      package:
        name: docker
        state: present

    - name: Start Docker service
      service:
        name: docker
        state: started
        enabled: yes

    - name: Pull the latest httpd image
      docker_image:
        name: httpd
        source: pull

    - name: Create a directory for the website content
      file:
        path: /var/www/html
        state: directory
        mode: '0755'

    - name: Write content to index.html
      copy:
        dest: /var/www/html/index.html
        content: |
          <!DOCTYPE html>
          <html>
          <head>
            <title>Welcome to HTTPD Server</title>
          </head>
          <body>
            <h1>Hello from HTTPD in a Docker container!</h1>
          </body>
          </html>

    - name: Create and start an httpd container
      docker_container:
        name: httpd_server
        image: httpd
        state: started
        ports:
          - "80:80"
        volumes:
          - /var/www/html:/usr/local/apache2/htdocs/
